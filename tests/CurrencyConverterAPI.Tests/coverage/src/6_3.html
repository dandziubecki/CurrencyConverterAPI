<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\Programming\open source\CurrencyConverterAPI\CurrencyConverterAPI\Services\FrankfurterApiCurrencyConverter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using CurrencyConverterAPI.Models;
using Microsoft.Extensions.Caching.Memory;
using System.Text.Json;

namespace CurrencyConverterAPI.Services;


public class FrankfurterApiCurrencyConverter : ICurrencyConverter
{
    private readonly HttpClient _httpClient;
    private readonly ILogger&lt;FrankfurterApiCurrencyConverter&gt; _logger;
    private readonly HashSet&lt;string&gt; _excludedCurrencies = new(StringComparer.OrdinalIgnoreCase) { &quot;TRY&quot;, &quot;PLN&quot;, &quot;THB&quot;, &quot;MXN&quot; };
    private readonly IMemoryCache _cache;

    public FrankfurterApiCurrencyConverter(IHttpClientFactory httpClientFactory, ILogger&lt;FrankfurterApiCurrencyConverter&gt; logger, IMemoryCache cache)
    {
        _httpClient = httpClientFactory.CreateClient(&quot;Frankfurter&quot;);
        _logger = logger;
        _cache = cache;
    }

    public bool IsCurrencyExcluded(string currency) =&gt; _excludedCurrencies.Contains(currency);

    public async Task&lt;ConversionResponse?&gt; ConvertCurrencyAsync(string from, string to, decimal amount)
    {
        var cacheKey = $&quot;convert_{from}_{to}_{amount}&quot;;
        return await _cache.GetOrCreateAsync(cacheKey, async entry =&gt;
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(1);
            _logger.LogInformation(&quot;Cache miss for {CacheKey}. Fetching from API.&quot;, cacheKey);

            try
            {
                var response = await _httpClient.GetAsync($&quot;latest?amount={amount}&amp;from={from}&amp;to={to}&quot;);
                response.EnsureSuccessStatusCode();
                var content = await response.Content.ReadAsStringAsync();
                var frankfurterResponse = JsonSerializer.Deserialize&lt;FrankfurterLatestResponse&gt;(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (frankfurterResponse is null) return null;

                return new ConversionResponse(frankfurterResponse.Amount, frankfurterResponse.Base, frankfurterResponse.Date, frankfurterResponse.Rates);
            }
            catch (HttpRequestException ex)
            {
                _logger.LogError(ex, &quot;Error converting currency from {From} to {To}&quot;, from, to);
                return null;
            }
        });
    }

    public async Task&lt;PaginatedHistoricalRatesResponse?&gt; GetHistoricalRatesAsync(string baseCurrency, DateOnly startDate, DateOnly endDate, int page, int pageSize)
    {
        var cacheKey = $&quot;historical_{baseCurrency}_{startDate:yyyy-MM-dd}_{endDate:yyyy-MM-dd}&quot;;

        var frankfurterResponse = await _cache.GetOrCreateAsync(cacheKey, async entry =&gt;
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromDays(1);
            _logger.LogInformation(&quot;Cache miss for {CacheKey}. Fetching from API.&quot;, cacheKey);
            try
            {
                var response = await _httpClient.GetAsync($&quot;{startDate:yyyy-MM-dd}..{endDate:yyyy-MM-dd}?from={baseCurrency}&quot;);
                response.EnsureSuccessStatusCode();
                var content = await response.Content.ReadAsStringAsync();
                return JsonSerializer.Deserialize&lt;FrankfurterHistoricalResponse&gt;(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            catch (HttpRequestException ex)
            {
                _logger.LogError(ex, &quot;Error getting historical rates for {BaseCurrency}&quot;, baseCurrency);
                return null;
            }
        });

        if (frankfurterResponse is null) return null;

        var filteredRates = frankfurterResponse.Rates
            .Select(kvp =&gt; new
            {
                Date = kvp.Key,
                Rates = kvp.Value.Where(r =&gt; !_excludedCurrencies.Contains(r.Key)).ToDictionary(r =&gt; r.Key, r =&gt; r.Value)
            })
            .ToDictionary(x =&gt; x.Date, x =&gt; x.Rates);

        var totalItems = filteredRates.Count;
        var totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);

        var paginatedRates = filteredRates
            .OrderBy(kvp =&gt; kvp.Key)
            .Skip((page - 1) * pageSize)
            .Take(pageSize)
            .ToDictionary(kvp =&gt; kvp.Key, kvp =&gt; kvp.Value);

        return new PaginatedHistoricalRatesResponse(
            frankfurterResponse.Base,
            frankfurterResponse.StartDate,
            frankfurterResponse.EndDate,
            page,
            pageSize,
            totalItems,
            totalPages,
            paginatedRates
        );
    }

    public string ProviderName =&gt; nameof(FrankfurterApiCurrencyConverter);

    public async Task&lt;LatestRatesResponse?&gt; GetLatestRatesAsync(string baseCurrency)
    {
        var cacheKey = $&quot;latest_{baseCurrency}&quot;;
        return await _cache.GetOrCreateAsync(cacheKey, async entry =&gt;
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(1);
            _logger.LogInformation(&quot;Cache miss for {CacheKey}. Fetching from API.&quot;, cacheKey);

            try
            {
                var response = await _httpClient.GetAsync($&quot;latest?from={baseCurrency}&quot;);
                response.EnsureSuccessStatusCode();
                var content = await response.Content.ReadAsStringAsync();
                var frankfurterResponse = JsonSerializer.Deserialize&lt;FrankfurterLatestResponse&gt;(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (frankfurterResponse is null) return null;

                var filteredRates = frankfurterResponse.Rates
                    .Where(kvp =&gt; !_excludedCurrencies.Contains(kvp.Key))
                    .ToDictionary(kvp =&gt; kvp.Key, kvp =&gt; kvp.Value);

                return new LatestRatesResponse(frankfurterResponse.Base, frankfurterResponse.Date, filteredRates);
            }
            catch (HttpRequestException ex)
            {
                _logger.LogError(ex, &quot;Error getting latest rates for {BaseCurrency}&quot;, baseCurrency);
                return null;
            }
        });
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[12,5,12,129,1],[15,5,15,150,1],[16,5,16,6,1],[17,9,17,69,1],[18,9,18,26,1],[19,9,19,24,1],[20,5,20,6,1],[22,56,22,94,1],[25,5,25,6,1],[26,9,26,56,1],[27,9,28,9,1],[28,9,28,10,1],[28,10,29,13,1],[29,13,29,75,1],[29,75,30,13,1],[30,13,30,95,1],[30,95,33,13,1],[33,13,33,14,1],[33,14,34,17,1],[34,17,34,106,1],[34,106,35,17,1],[35,17,35,52,1],[35,52,36,17,1],[36,17,36,74,1],[36,74,37,17,1],[37,17,37,172,1],[37,172,39,17,1],[39,17,39,49,1],[39,49,39,50,1],[39,50,39,62,0],[39,62,41,17,1],[41,17,41,154,1],[41,154,43,13,1],[43,13,43,44,1],[43,44,44,13,1],[44,13,44,14,1],[44,14,45,17,1],[45,17,45,97,1],[45,97,46,17,1],[46,17,46,29,1],[46,29,48,9,1],[48,9,48,10,1],[48,10,48,12,1],[49,5,49,6,1],[52,5,52,6,1],[53,9,53,97,1],[55,9,56,9,1],[56,9,56,10,1],[56,10,57,13,1],[57,13,57,74,1],[57,74,58,13,1],[58,13,58,95,1],[58,95,60,13,1],[60,13,60,14,1],[60,14,61,17,1],[61,17,61,128,1],[61,128,62,17,1],[62,17,62,52,1],[62,52,63,17,1],[63,17,63,74,1],[63,74,64,17,1],[64,17,64,157,1],[64,157,66,13,1],[66,13,66,44,0],[66,44,67,13,1],[67,13,67,14,0],[67,14,68,17,1],[68,17,68,105,0],[68,105,69,17,1],[69,17,69,29,0],[69,29,71,9,1],[71,9,71,10,1],[71,10,71,12,1],[73,9,73,41,1],[73,42,73,54,0],[75,9,76,28,1],[76,28,79,46,1],[79,46,79,82,1],[79,82,79,102,1],[79,102,79,107,1],[79,107,79,114,1],[79,114,79,121,1],[79,121,80,14,1],[80,14,81,32,1],[81,32,81,38,1],[81,38,81,45,1],[81,45,81,52,1],[81,52,81,54,1],[83,9,83,46,1],[84,9,84,75,1],[86,9,87,29,1],[87,29,87,36,1],[87,36,90,34,1],[90,34,90,41,1],[90,41,90,50,1],[90,50,90,59,1],[90,59,90,61,1],[92,9,101,11,1],[102,5,102,6,1],[104,35,104,74,1],[107,5,107,6,1],[108,9,108,49,1],[109,9,110,9,1],[110,9,110,10,1],[110,10,111,13,1],[111,13,111,75,1],[111,75,112,13,1],[112,13,112,95,1],[112,95,115,13,1],[115,13,115,14,1],[115,14,116,17,1],[116,17,116,90,1],[116,90,117,17,1],[117,17,117,52,1],[117,52,118,17,1],[118,17,118,74,1],[118,74,119,17,1],[119,17,119,172,1],[119,172,121,17,1],[121,17,121,49,1],[121,49,121,50,1],[121,50,121,62,0],[121,62,123,17,1],[123,17,124,35,1],[124,35,124,73,1],[124,73,125,42,1],[125,42,125,49,1],[125,49,125,58,1],[125,58,125,67,1],[125,67,125,69,1],[125,69,127,17,1],[127,17,127,115,1],[127,115,129,13,1],[129,13,129,44,0],[129,44,130,13,1],[130,13,130,14,0],[130,14,131,17,1],[131,17,131,101,0],[131,101,132,17,1],[132,17,132,29,0],[132,29,134,9,1],[134,9,134,10,1],[134,10,134,12,1],[135,5,135,6,1]]);
    </script>
  </body>
</html>