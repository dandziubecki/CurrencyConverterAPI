<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\Programming\open source\CurrencyConverterAPI\CurrencyConverterAPI\Services\HeaderBasedCurrencyServiceResolver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.Extensions.Primitives;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using System.Linq;

namespace CurrencyConverterAPI.Services;

public interface IHeaderBasedCurrencyConverterFactory
{
    ICurrencyConverter ResolveService();
}

public class HeaderBasedCurrencyConverterFactory : IHeaderBasedCurrencyConverterFactory
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    private readonly IServiceProvider  _serviceProvider;
    private readonly ILogger&lt;HeaderBasedCurrencyConverterFactory&gt; _logger;
    private const string ProviderHeaderName = &quot;X-Currency-Provider&quot;;
    private const string DefaultProvider = &quot;FrankfurterApiCurrencyConverter&quot;;

    public HeaderBasedCurrencyConverterFactory(
        IHttpContextAccessor httpContextAccessor,
        ILogger&lt;HeaderBasedCurrencyConverterFactory&gt; logger, 
        IServiceProvider serviceProvider)
    {
        _httpContextAccessor = httpContextAccessor;
        _logger = logger;
        _serviceProvider = serviceProvider;
    }

    public ICurrencyConverter ResolveService()
    {
        var httpContext = _httpContextAccessor.HttpContext;
        if (httpContext == null)
        {
            _logger.LogWarning(&quot;HttpContext is null, using default provider: {DefaultProvider}&quot;, DefaultProvider);
            return _serviceProvider.GetRequiredKeyedService&lt;ICurrencyConverter&gt;(DefaultProvider);
        }

        var providerName = GetProviderNameFromHeader(httpContext);
        
        try
        {
            var service = _serviceProvider.GetRequiredKeyedService&lt;ICurrencyConverter&gt;(providerName);
            _logger.LogInformation(&quot;Resolved currency service: {ProviderName}&quot;, service.ProviderName);
            return service;
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, &quot;Provider &#39;{ProviderName}&#39; not supported, falling back to default: {DefaultProvider}&quot;, 
                providerName, DefaultProvider);
            return _serviceProvider.GetRequiredKeyedService&lt;ICurrencyConverter&gt;(DefaultProvider);
        }
    }

    private string GetProviderNameFromHeader(HttpContext httpContext)
    {
        if (httpContext.Request.Headers.TryGetValue(ProviderHeaderName, out StringValues headerValues))
        {
            var providerName = headerValues.FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(providerName))
            {
                _logger.LogInformation(&quot;Found provider in header: {ProviderName}&quot;, providerName);
                return providerName;
            }
        }

        _logger.LogInformation(&quot;No provider specified in header &#39;{HeaderName}&#39;, using default: {DefaultProvider}&quot;, 
            ProviderHeaderName, DefaultProvider);
        return DefaultProvider;
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,5,24,42,1],[25,5,25,6,1],[26,9,26,52,1],[27,9,27,26,1],[28,9,28,44,1],[29,5,29,6,1],[32,5,32,6,1],[33,9,33,60,1],[34,9,34,33,1],[35,9,35,10,1],[36,13,36,115,1],[37,13,37,98,1],[40,9,40,67,1],[43,9,43,10,1],[44,13,44,102,1],[45,13,45,103,1],[46,13,46,28,1],[48,9,48,29,1],[49,9,49,10,1],[50,13,51,48,1],[52,13,52,98,1],[54,5,54,6,1],[57,5,57,6,1],[58,9,58,104,1],[59,9,59,10,1],[60,13,60,62,1],[61,13,61,58,1],[62,13,62,14,1],[63,17,63,98,1],[64,17,64,37,1],[66,9,66,10,1],[68,9,69,50,1],[70,9,70,32,1],[71,5,71,6,1]]);
    </script>
  </body>
</html>